<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras</title>
    <!-- Importa el nuevo archivo base de estilos (incluye Font Awesome y dark mode) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/carrito.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üõí Tu Carrito de Compras</h1>
            <!-- Bot√≥n de Claro/Oscuro -->
            <button id="theme-toggle" aria-label="Cambiar tema">
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon"></i>
            </button>
        </header>

        <div class="acciones-top">
            <a href="/" class="btn-accion">Seguir Comprando</a>
            {% if carrito %}
                <a href="/vaciar" class="btn-accion btn-vaciar">Vaciar Carrito</a>
            {% endif %}
        </div>

        <div class="carrito-container">
            {% if carrito %}
                <ul class="carrito-items">
                    {% for item in carrito %}
                        <li class="carrito-item">
                            <img src="{{ item.imagen }}" alt="{{ item.nombre }}" class="item-img">
                            <span class="item-nombre">{{ item.nombre }}</span>
                            <div class="cantidad-container">
                                <a href="/cambiar_cantidad/{{ item.id }}/{{ item.cantidad - 1 }}" class="btn-cantidad">-</a>
                                <span class="cantidad-actual">{{ item.cantidad }}</span>
                                <a href="/cambiar_cantidad/{{ item.id }}/{{ item.cantidad + 1 }}" class="btn-cantidad">+</a>
                            </div>
                            <span class="item-precio-total">${{ "%.2f"|format(item.precio * item.cantidad) }}</span>
                        </li>
                    {% endfor %}
                </ul>

                <div class="carrito-total">
                    Total: <span>${{ "%.2f"|format(total) }}</span>
                </div>

                <button id="btn-iniciar-pago" class="btn-pagar">
                    Finalizar Compra (${{ "%.2f"|format(total) }})
                </button>

            {% else %}
                <p style="text-align: center; font-size: 1.2rem; padding: 50px;">
                    Tu carrito est√° vac√≠o. ¬°A√±ade algunas milanesas! üòã
                </p>
            {% endif %}
        </div>
    </div>

    <!-- ===== INICIO: MODAL DE PAGO (sin cambios) ===== -->
    <div id="modal-pago" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Procesar Pago</h2>
                <button class="btn-cerrar-modal" aria-label="Cerrar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="payment-form">
                    <form id="form-pago">
                        <div class="form-group">
                            <label for="card-number">N√∫mero de Tarjeta</label>
                            <input type="text" id="card-number" class="form-control" placeholder="XXXX XXXX XXXX XXXX" required>
                        </div>
                        <div class="form-group">
                            <label for="card-name">Nombre en la Tarjeta</label>
                            <input type="text" id="card-name" class="form-control" placeholder="Juan P√©rez" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="card-expiry">Vencimiento (MM/AA)</label>
                                <input type="text" id="card-expiry" class="form-control" placeholder="12/26" required>
                            </div>
                            <div class="form-group">
                                <label for="card-cvc">CVC</label>
                                <input type="text" id="card-cvc" class="form-control" placeholder="123" required>
                            </div>
                        </div>
                        
                        <button type="submit" id="btn-submit-pago" class="btn-pagar">
                            Pagar ${{ "%.2f"|format(total) }}
                        </button>
                    </form>
                </div>
                
                <div id="success-message" class="success-message">
                    ‚úÖ ¬°Pago procesado con √©xito! Redirigiendo...
                </div>
                
                <div id="error-message" class="error-message">
                    ‚ùå Error al procesar el pago. Por favor, intente de nuevo.
                </div>
            </div>
        </div>
    </div>
    <!-- ===== FIN: MODAL DE PAGO ===== -->


    <!-- ===== INICIO: SCRIPT DEL MODAL Y TEMA ===== -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // ---------------------------------
        // 1. L√ìGICA DE MODO CLARO/OSCURO
        // ---------------------------------
        const themeToggle = document.getElementById('theme-toggle');
        
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme) {
            document.body.classList.toggle('dark-mode', storedTheme === 'dark');
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });


        // ---------------------------------
        // 2. L√ìGICA DEL MODAL DE PAGO
        // ---------------------------------
        const modal = document.getElementById('modal-pago');
        const btnPagar = document.getElementById('btn-iniciar-pago');
        const btnCerrar = modal.querySelector('.btn-cerrar-modal');
        const paymentForm = document.getElementById('payment-form');
        const formPago = document.getElementById('form-pago');
        const btnSubmitPago = document.getElementById('btn-submit-pago');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');

        if (btnPagar) {
             btnPagar.addEventListener('click', () => {
                modal.style.display = 'flex';
                // Resetear el estado del modal
                paymentForm.style.display = 'block';
                successMessage.style.display = 'none';
                errorMessage.style.display = 'none';
            });
        }
        
        btnCerrar.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Manejo del env√≠o del formulario de pago
        formPago.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Deshabilita el bot√≥n y cambia el texto
            btnSubmitPago.disabled = true;
            btnSubmitPago.textContent = 'Procesando...';
            errorMessage.style.display = 'none'; // Oculta errores previos

            // Simulaci√≥n de la llamada a la API
            fetch('/api/procesar_pago', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Respuesta del servidor no fue OK');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Muestra mensaje de √©xito
                    paymentForm.style.display = 'none'; // Oculta el formulario
                    successMessage.style.display = 'block'; // Muestra el √©xito

                    // Redirige al inicio despu√©s de 2.5 segundos
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2500);
                } else {
                    // Si la API devuelve success: false
                    throw new Error(data.message || 'Error desconocido');
                }
            })
            .catch(error => {
                // Muestra mensaje de error en caso de fallo del fetch o de la API
                console.error('Error en el pago:', error);
                errorMessage.style.display = 'block';
                btnSubmitPago.disabled = false; // Reactiva el bot√≥n
                // Restaura el texto del bot√≥n al total original
                const totalText = document.querySelector('.carrito-total span').textContent;
                btnSubmitPago.textContent = `Pagar ${totalText}`;
            });
        });
    });
    </script>
    <!-- ===== FIN: SCRIPT DEL MODAL ===== -->
</body>
</html>
