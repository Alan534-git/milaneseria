<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda - Din√°mica</title>
    <!-- Importa el nuevo archivo base de estilos (incluye Font Awesome y dark mode) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè™ Tienda Online</h1>
            <div class="header-right">
                <!-- Bot√≥n de Claro/Oscuro -->
                <button id="theme-toggle" aria-label="Cambiar tema">
                    <i class="fas fa-sun"></i>
                    <i class="fas fa-moon"></i>
                </button>
                <!-- Bot√≥n de Carrito -->
                <a href="/carrito" class="btn-carrito">
                    üõí Ver Carrito (<span id="cart-count">{{ total_cantidad }}</span>)
                </a>
            </div>
        </header>

        <hr>

        <h2>Nuestros Productos</h2>
        <div class="productos-container">
            {% for p in productos %}
                <div class="producto-card" data-product-id="{{ p.id }}">
                    <img src="{{ p.imagen }}" alt="Imagen de {{ p.nombre }}" class="producto-img">
                    <div class="producto-info">
                        <h3>{{ p.nombre }}</h3>

                        <div class="precio-refrescos-container">
                            <p class="precio-main">$<span class="milanesa-precio">{{ "%.2f"|format(p.precio) }}</span></p>

                            <!-- Selector de Refrescos (5 Marcas Conocidas) -->
                            <div class="refrescos-selector" data-base-price="{{ p.precio }}">
                                <!-- Los precios son ficticios para la simulaci√≥n -->
                                <button class="btn-refresco" data-refresco-id="1" data-price="1.50" aria-label="Refresco Coca-Cola">
                                    <i class="fa-solid fa-c"></i>
                                    <span class="tooltip-refresco">Refresco C: $1.50</span>
                                </button>
                                <button class="btn-refresco" data-refresco-id="2" data-price="1.75" aria-label="Refresco Pepsi">
                                    <i class="fa-solid fa-p"></i>
                                    <span class="tooltip-refresco">Refresco P: $1.75</span>
                                </button>
                                <button class="btn-refresco" data-refresco-id="3" data-price="1.25" aria-label="Refresco Sprite">
                                    <i class="fa-solid fa-s"></i>
                                    <span class="tooltip-refresco">Refresco S: $1.25</span>
                                </button>
                                <button class="btn-refresco" data-refresco-id="4" data-price="1.60" aria-label="Refresco Fanta">
                                    <i class="fa-solid fa-f"></i>
                                    <span class="tooltip-refresco">Refresco F: $1.60</span>
                                </button>
                                <button class="btn-refresco" data-refresco-id="5" data-price="1.00" aria-label="Refresco 7Up">
                                    <i class="fa-solid fa-7"></i>
                                    <span class="tooltip-refresco">Refresco 7: $1.00</span>
                                </button>
                            </div>
                        </div>

                        <a href="/agregar/{{ p.id }}" class="btn-agregar" data-product-id="{{ p.id }}" data-refresco-price="0">
                            ‚ûï Agregar al carrito
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <script>
    // Datos de los refrescos para el script
    const refrescoData = {
        '1': 1.50, // Coca-Cola
        '2': 1.75, // Pepsi
        '3': 1.25, // Sprite
        '4': 1.60, // Fanta
        '5': 1.00  // 7Up
    };

    document.addEventListener('DOMContentLoaded', function() {
        const cartCountSpan = document.getElementById('cart-count');
        const themeToggle = document.getElementById('theme-toggle');

        // ---------------------------------
        // 1. L√ìGICA DE MODO CLARO/OSCURO
        // ---------------------------------
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme) {
            document.body.classList.toggle('dark-mode', storedTheme === 'dark');
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            // Establecer modo oscuro por defecto si el sistema lo prefiere
            document.body.classList.add('dark-mode');
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });


        // ---------------------------------
        // 2. L√ìGICA DE SELECCI√ìN DE REFRESCOS
        // ---------------------------------

        const productoCards = document.querySelectorAll('.producto-card');

        productoCards.forEach(card => {
            const selector = card.querySelector('.refrescos-selector');
            const basePrice = parseFloat(selector.dataset.basePrice);
            const precioDisplay = card.querySelector('.milanesa-precio');
            const btnAgregar = card.querySelector('.btn-agregar');
            const refreshButtons = card.querySelectorAll('.btn-refresco');

            // Funci√≥n para actualizar el precio y el data-attribute
            const updatePrice = (refrescoPrice) => {
                const newTotalPrice = basePrice + refrescoPrice;
                // Actualiza la visualizaci√≥n del precio
                precioDisplay.textContent = newTotalPrice.toFixed(2);
                // Actualiza el atributo que se usar√° para el env√≠o al servidor (simulado)
                btnAgregar.dataset.refrescoPrice = refrescoPrice.toFixed(2);
                // Actualiza el texto del bot√≥n Agregar
                btnAgregar.textContent = `‚ûï Agregar al carrito ($${newTotalPrice.toFixed(2)})`;
            };

            // Inicializar el bot√≥n de agregar con el precio base
            updatePrice(0);


            refreshButtons.forEach(btn => {
                const price = parseFloat(btn.dataset.price);

                // Manejar la selecci√≥n del refresco
                btn.addEventListener('click', () => {
                    let refrescoPrice = 0;
                    
                    // Si el bot√≥n ya est√° seleccionado, lo deseleccionamos
                    if (btn.classList.contains('selected')) {
                        btn.classList.remove('selected');
                        // El precio del refresco es 0, volvemos solo al precio base
                    } else {
                        // Deselecciona cualquier otro bot√≥n en el mismo grupo
                        refreshButtons.forEach(b => b.classList.remove('selected'));
                        
                        // Selecciona el bot√≥n actual
                        btn.classList.add('selected');
                        refrescoPrice = price;
                    }

                    // Actualiza el precio
                    updatePrice(refrescoPrice);
                });
            });


            // ---------------------------------
            // 3. L√ìGICA DE AGREGAR AL CARRITO (AJAX)
            // ---------------------------------
            btnAgregar.addEventListener('click', function(event) {
                // Previene el comportamiento por defecto del enlace
                event.preventDefault();

                // Aqu√≠ obtenemos el precio del refresco seleccionado.
                // IMPORTANTE: Dado que la l√≥gica del servidor (app.py) espera solo el ID,
                // este precio de refresco es solo para *fines visuales y de demo*.
                // En una app real, el precio del refresco y su ID DEBER√çAN
                // enviarse al servidor para ser incluidos como un √≠tem de l√≠nea.
                
                const productId = this.dataset.productId;
                const url = `/api/agregar/${productId}`;

                // Usa la API Fetch para enviar una solicitud POST al servidor
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('La respuesta de la red no fue correcta');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.total_cantidad !== undefined) {
                        // Actualiza el n√∫mero en el bot√≥n del carrito
                        cartCountSpan.textContent = data.total_cantidad;
                    }
                })
                .catch(error => {
                    console.error('Hubo un problema con la operaci√≥n de fetch:', error);
                });
            });
        });
    });
    </script>
</body>
</html>
